name: CD

run-name: >-
  ${{ github.event_name == 'workflow_dispatch' && format('CD (ìˆ˜ë™): {0} â†’ {1}', github.event.head_commit.message || github.ref_name, inputs.environment) ||
      github.event_name == 'workflow_call' && format('CD ({0}): {1} â†’ {2}', inputs.triggered_by, github.event.head_commit.message || github.ref_name, inputs.environment) ||
      format('CD â†’ {0}', inputs.environment || 'production') }}

on:
  workflow_call:
    inputs:
      environment:
        description: "ë°°í¬ í™˜ê²½"
        required: true
        type: string
      triggered_by:
        description: "íŠ¸ë¦¬ê±° ì†ŒìŠ¤"
        required: false
        type: string
        default: "manual"
  workflow_dispatch:
    inputs:
      environment:
        description: "ë°°í¬í•  í™˜ê²½ì„ ì„ íƒí•˜ì„¸ìš”"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

permissions:
  contents: read

env:
  # Slack ì•Œë¦¼ ìƒ‰ìƒ ì •ì˜
  SLACK_START_COLOR: "#155dfc"
  SLACK_SUCCESS_COLOR: "#00a63e"
  SLACK_FAILURE_COLOR: "#e7000b"

  # Docker ê´€ë ¨ ì„¤ì •
  DOCKER_PLATFORM: "linux/arm64"
  DOCKER_COMPOSE_VERSION: "v2.24.5"

  # í”„ë¡œì íŠ¸ ê´€ë ¨ ì„¤ì •
  PROJECT_NAME: "story-dict"
  ECR_FE_REPO: "1-blue/story-dict-fe"
  ECR_BE_REPO: "1-blue/story-dict-be"

  # ì‹œê°„ëŒ€ ì„¤ì •
  TZ: "Asia/Seoul"

  # Slack ê³µí†µ í•„ë“œ - ì¢…ë£Œ ì•Œë¦¼ì—ì„œ ì¬ì‚¬ìš©
  SLACK_COMMON_FIELDS: |
    {
      "title": "íŠ¸ë¦¬ê±°",
      "value": "${{ inputs.triggered_by }}",
      "short": true
    },
    {
      "title": "ì›Œí¬í”Œë¡œìš° ëª©ë¡",
      "value": "<https://github.com/1-blue/story-dict/actions|Actions ëª©ë¡>",
      "short": true
    },
    {
      "title": "ì•¡ì…˜ì‘ì—…",
      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }} ì‘ì—…>",
      "short": true
    },
    {
      "title": "ë¸Œëœì¹˜",
      "value": "${{ github.ref_name }}",
      "short": true
    },
    {
      "title": "ì‹¤í–‰ì",
      "value": "${{ github.actor }}",
      "short": true
    },
    {
      "title": "ECR ë ˆí¬ì§€í† ë¦¬",
      "value": "<https://ap-northeast-2.console.aws.amazon.com/ecr/private-registry/repositories?region=ap-northeast-2|ECR ë ˆí¬>",
      "short": true
    },
    {
      "title": "S3 ë¹Œë“œ ìºì‹œ",
      "value": "<https://ap-northeast-2.console.aws.amazon.com/s3/buckets/storydict?region=ap-northeast-2&bucketType=general&prefix=builds/&showversions=false|S3 ìºì‹œ>",
      "short": true
    }

jobs:
  # ë¹Œë“œ ì‘ì—… (ê³µí†µ)
  build:
    name: Build Images
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      source_hash: ${{ steps.source-hash.outputs.SOURCE_HASH }}
      skip_fe_build: ${{ steps.early-ecr-check.outputs.FE_EXISTS }}
      skip_be_build: ${{ steps.early-ecr-check.outputs.BE_EXISTS }}
      skip_all_build: ${{ steps.early-ecr-check.outputs.SKIP_ALL_BUILD }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # ì‹œì‘ ì‹œê°„ ë° ì»¤ë°‹ ì •ë³´ ì„¤ì • (í†µí•©)
      - name: Set deploy info and start time
        run: |
          echo "START_TIME=$(date +%s)" >> $GITHUB_ENV
          echo "START_TIME_FORMATTED=$(date '+%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„ %Sì´ˆ')" >> $GITHUB_ENV
          SUBJECT=$(git log -1 --pretty=%s)
          echo "COMMIT_SUBJECT=$SUBJECT" >> $GITHUB_ENV

      # ì†ŒìŠ¤ì½”ë“œ í•´ì‹œ ê³„ì‚° (ì¡°ê¸° ì‹¤í–‰)
      - name: Calculate source hash
        id: source-hash
        run: |
          SOURCE_HASH=$(find apps packages -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.json" -o -name "*.prisma" | grep -v "/dist/" | grep -v "/.next/" | sort | xargs cat | sha256sum | cut -d' ' -f1)
          echo "SOURCE_HASH=$SOURCE_HASH" >> $GITHUB_OUTPUT
          echo "âœ… ì†ŒìŠ¤ì½”ë“œ í•´ì‹œ: $SOURCE_HASH"

      # AWS ì¸ì¦ ì„¤ì • (ì¡°ê¸° ì‹¤í–‰)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_ACCESS_SECRET_KEY }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ECR ì´ë¯¸ì§€ ì¡°ê¸° í™•ì¸
      - name: Early ECR image check
        id: early-ecr-check
        run: |
          export ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
          SOURCE_HASH=${{ steps.source-hash.outputs.SOURCE_HASH }}

          # FE ì´ë¯¸ì§€ í™•ì¸
          if aws ecr describe-images \
            --repository-name ${{ env.ECR_FE_REPO }} \
            --image-ids imageTag=${SOURCE_HASH} \
            --region ${{ secrets.AWS_REGION }} 2>/dev/null; then
            echo "FE_EXISTS=true" >> $GITHUB_OUTPUT
            echo "âœ… FE ì´ë¯¸ì§€ ì¡´ì¬ (${SOURCE_HASH})"
          else
            echo "FE_EXISTS=false" >> $GITHUB_OUTPUT
            echo "âŒ FE ì´ë¯¸ì§€ ì—†ìŒ"
          fi

          # BE ì´ë¯¸ì§€ í™•ì¸
          if aws ecr describe-images \
            --repository-name ${{ env.ECR_BE_REPO }} \
            --image-ids imageTag=${SOURCE_HASH} \
            --region ${{ secrets.AWS_REGION }} 2>/dev/null; then
            echo "BE_EXISTS=true" >> $GITHUB_OUTPUT
            echo "âœ… BE ì´ë¯¸ì§€ ì¡´ì¬ (${SOURCE_HASH})"
          else
            echo "BE_EXISTS=false" >> $GITHUB_OUTPUT
            echo "âŒ BE ì´ë¯¸ì§€ ì—†ìŒ"
          fi

          # ë‘˜ ë‹¤ ìˆìœ¼ë©´ ë¹Œë“œ ì™„ì „ ìŠ¤í‚µ
          if [[ "$FE_EXISTS" == "true" && "$BE_EXISTS" == "true" ]]; then
            echo "SKIP_ALL_BUILD=true" >> $GITHUB_OUTPUT
            echo "ğŸ‰ ëª¨ë“  ì´ë¯¸ì§€ ì¡´ì¬ - ë¹Œë“œ ì™„ì „ ìŠ¤í‚µ, ë°°í¬ë§Œ ì§„í–‰"
          else
            echo "SKIP_ALL_BUILD=false" >> $GITHUB_OUTPUT
            echo "ğŸ”¨ ì¼ë¶€ ì´ë¯¸ì§€ ì—†ìŒ - ë¹Œë“œ í•„ìš”"
          fi

      # ì˜ì¡´ì„± ì„¤ì¹˜ (ë¹Œë“œê°€ í•„ìš”í•œ ê²½ìš°ë§Œ)
      - name: Setup pnpm and dependencies
        if: steps.early-ecr-check.outputs.SKIP_ALL_BUILD == 'false'
        run: |
          curl -fsSL https://get.pnpm.io/install.sh | sh -
          export PATH="$HOME/.local/share/pnpm:$PATH"
          pnpm --version
          pnpm install --frozen-lockfile

      # S3 ë¹Œë“œ ìºì‹œ ë³µì› (ë¹Œë“œê°€ í•„ìš”í•œ ê²½ìš°ë§Œ)
      - name: Restore build cache from S3
        if: steps.early-ecr-check.outputs.SKIP_ALL_BUILD == 'false'
        id: s3-cache
        run: |
          SOURCE_HASH=${{ steps.source-hash.outputs.SOURCE_HASH }}
          if aws s3 ls s3://${{ secrets.AWS_S3_BUCKET }}/builds/${SOURCE_HASH}.tar.gz; then
            echo "âœ… ë¹Œë“œ ìºì‹œ ë°œê²¬. ë³µì› ì¤‘... (í•´ì‹œ: $SOURCE_HASH)"
            aws s3 cp s3://${{ secrets.AWS_S3_BUCKET }}/builds/${SOURCE_HASH}.tar.gz ./build-cache.tar.gz
            tar -xzf build-cache.tar.gz
            echo "BUILD_CACHE_HIT=true" >> $GITHUB_OUTPUT
            echo "ìºì‹œ ë³µì› ì™„ë£Œ"
          else
            echo "âŒ ë¹Œë“œ ìºì‹œ ì—†ìŒ. ìƒˆë¡œ ë¹Œë“œí•©ë‹ˆë‹¤ (í•´ì‹œ: $SOURCE_HASH)"
            echo "BUILD_CACHE_HIT=false" >> $GITHUB_OUTPUT
          fi

      # ë¹Œë“œ ì‹¤í–‰ (ìºì‹œ ë¯¸ìŠ¤ ì‹œì—ë§Œ)
      - name: Build applications (cache miss)
        if: steps.early-ecr-check.outputs.SKIP_ALL_BUILD == 'false' && steps.s3-cache.outputs.BUILD_CACHE_HIT == 'false'
        run: |
          echo "ğŸ”¨ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì¤‘..."
          export PATH="$HOME/.local/share/pnpm:$PATH"
          pnpm build

          SOURCE_HASH=${{ steps.source-hash.outputs.SOURCE_HASH }}
          echo "ğŸ’¾ S3ì— ë¹Œë“œ ìºì‹œ ì €ì¥ ì¤‘..."
          tar -czf ${SOURCE_HASH}.tar.gz \
            --ignore-failed-read \
            apps/fe/.next/standalone \
            apps/fe/.next/static \
            apps/fe/.next \
            apps/fe/public \
            apps/be/dist \
            packages/

          aws s3 cp ${SOURCE_HASH}.tar.gz \
            s3://${{ secrets.AWS_S3_BUCKET }}/builds/

          echo "âœ… ë¹Œë“œ ìºì‹œ ì €ì¥ ì™„ë£Œ (í•´ì‹œ: $SOURCE_HASH)"

      # Prisma í´ë¼ì´ì–¸íŠ¸ ìƒì„± (ë¹Œë“œê°€ í•„ìš”í•œ ê²½ìš°ë§Œ)
      - name: Generate Prisma client
        if: steps.early-ecr-check.outputs.SKIP_ALL_BUILD == 'false'
        run: |
          export PATH="$HOME/.local/share/pnpm:$PATH"
          pnpm db:generate

      # CD ì‹œì‘ ì•Œë¦¼ (ê°„ì†Œí™”)
      - name: Notify Slack on Start
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ env.SLACK_START_COLOR }}",
                  "title": "ğŸš€ ë°°í¬ ì‹œì‘",
                  "text": "${{ env.COMMIT_SUBJECT }}",
                  "fields": [
                    {
                      "title": "í™˜ê²½",
                      "value": "${{ inputs.environment }}",
                      "short": true
                    },
                    {
                      "title": "íŠ¸ë¦¬ê±°",
                      "value": "${{ inputs.triggered_by }}",
                      "short": true
                    },
                    {
                      "title": "ì‹¤í–‰ì",
                      "value": "${{ github.actor }}",
                      "short": true
                    },
                    {
                      "title": "ì•¡ì…˜ì‘ì—…",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }} ì‘ì—…>",
                      "short": true
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEPLOY_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      # Docker ì„¤ì • (ì´ë¯¸ì§€ ë¹Œë“œê°€ í•„ìš”í•œ ê²½ìš°ë§Œ)
      - name: Set up QEMU and Docker Buildx
        if: steps.early-ecr-check.outputs.SKIP_ALL_BUILD == 'false'
        run: |
          # QEMU ì„¤ì •
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          # Buildx ì„¤ì •
          docker buildx create --use --name multi-arch-builder --driver docker-container || true
          docker buildx inspect --bootstrap

      # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° íƒœê·¸ (í•„ìš”í•œ ì´ë¯¸ì§€ë§Œ)
      - name: Build and tag Docker images
        if: steps.early-ecr-check.outputs.SKIP_ALL_BUILD == 'false'
        run: |
          export ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
          SOURCE_HASH=${{ steps.source-hash.outputs.SOURCE_HASH }}

          # FE ì´ë¯¸ì§€ ë¹Œë“œ (ì—†ëŠ” ê²½ìš°ë§Œ)
          if [[ "${{ steps.early-ecr-check.outputs.FE_EXISTS }}" == "false" ]]; then
            echo "ğŸ”¨ FE ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
            DOCKER_DEFAULT_PLATFORM=${{ env.DOCKER_PLATFORM }} docker build \
              -f apps/fe/Dockerfile \
              -t ${{ env.ECR_FE_REPO }}:latest \
              -t $ECR_REGISTRY/${{ env.ECR_FE_REPO }}:latest \
              -t $ECR_REGISTRY/${{ env.ECR_FE_REPO }}:${SOURCE_HASH} \
              .
          fi

          # BE ì´ë¯¸ì§€ ë¹Œë“œ (ì—†ëŠ” ê²½ìš°ë§Œ)
          if [[ "${{ steps.early-ecr-check.outputs.BE_EXISTS }}" == "false" ]]; then
            echo "ğŸ”¨ BE ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
            DOCKER_DEFAULT_PLATFORM=${{ env.DOCKER_PLATFORM }} docker build \
              -f apps/be/Dockerfile \
              -t ${{ env.ECR_BE_REPO }}:latest \
              -t $ECR_REGISTRY/${{ env.ECR_BE_REPO }}:latest \
              -t $ECR_REGISTRY/${{ env.ECR_BE_REPO }}:${SOURCE_HASH} \
              .
          fi

      # ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ (ë¹Œë“œëœ ì´ë¯¸ì§€ë§Œ)
      - name: Push images to ECR
        if: steps.early-ecr-check.outputs.SKIP_ALL_BUILD == 'false'
        run: |
          export ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
          SOURCE_HASH=${{ steps.source-hash.outputs.SOURCE_HASH }}

          # FE ì´ë¯¸ì§€ í‘¸ì‹œ (ë¹Œë“œëœ ê²½ìš°ë§Œ)
          if [[ "${{ steps.early-ecr-check.outputs.FE_EXISTS }}" == "false" ]]; then
            echo "ğŸ“¤ FE ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘..."
            docker push $ECR_REGISTRY/${{ env.ECR_FE_REPO }}:latest
            docker push $ECR_REGISTRY/${{ env.ECR_FE_REPO }}:${SOURCE_HASH}
            echo "âœ… FE ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ"
          fi

          # BE ì´ë¯¸ì§€ í‘¸ì‹œ (ë¹Œë“œëœ ê²½ìš°ë§Œ)
          if [[ "${{ steps.early-ecr-check.outputs.BE_EXISTS }}" == "false" ]]; then
            echo "ğŸ“¤ BE ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘..."
            docker push $ECR_REGISTRY/${{ env.ECR_BE_REPO }}:latest
            docker push $ECR_REGISTRY/${{ env.ECR_BE_REPO }}:${SOURCE_HASH}
            echo "âœ… BE ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ"
          fi

  # FE ë°°í¬ ì‘ì—…
  deploy-fe:
    name: Deploy Frontend
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ì‹œì‘ ì‹œê°„ ì„¤ì •
      - name: Set start time
        run: |
          echo "FE_START_TIME=$(date +%s)" >> $GITHUB_ENV
          echo "FE_START_TIME_FORMATTED=$(date '+%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„ %Sì´ˆ')" >> $GITHUB_ENV

      # AWS ì¸ì¦
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_ACCESS_SECRET_KEY }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ë™ì  ë³´ì•ˆ ê·¸ë£¹ ê´€ë¦¬
      - name: Add GitHub Actions IP to FE Security Group
        id: add-ip-fe
        run: |
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "FE_RUNNER_IP=$RUNNER_IP" >> $GITHUB_ENV
          echo "FE ë³´ì•ˆ ê·¸ë£¹ì— GitHub Actions IP ì¶”ê°€ ì¤‘: $RUNNER_IP"

          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.AWS_FE_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr $RUNNER_IP/32

      # FE ë°°í¬
      - name: Deploy Frontend to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          FE_ENV: ${{ secrets.FRONTEND_ENV_FILE }}
          SOURCE_HASH: ${{ needs.build.outputs.source_hash }}
        with:
          host: ${{ secrets.AWS_FE_EC2_SSH_DNS }}
          username: ${{ secrets.AWS_FE_EC2_SSH_USER_NAME }}
          key: ${{ secrets.AWS_FE_EC2_SSH_PEM_KEY }}
          port: ${{ secrets.AWS_FE_EC2_SSH_PORT }}
          envs: ECR_REGISTRY,AWS_REGION,FE_ENV,SOURCE_HASH
          script: |
            set -e

            # ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p ~/workspace/envs
            cd ~/workspace

            # docker-compose.fe.yml ìƒì„±
            cat > docker-compose.fe.yml << EOF
            version: "3"

            services:
              fe:
                container_name: fe
                platform: linux/arm64
                image: $ECR_REGISTRY/1-blue/story-dict-fe:latest
                restart: always
                env_file:
                  - ./envs/.env.production
                ports:
                  - 9000:9000
            EOF

            # í™˜ê²½ íŒŒì¼ ìƒì„±
            echo "$FE_ENV" > ./envs/.env.production

            # ECR ë¡œê·¸ì¸
            aws ecr get-login-password --region $AWS_REGION | \
              docker login --username AWS --password-stdin $ECR_REGISTRY

            # ì»¨í…Œì´ë„ˆ ì •ë¦¬
            if [ "$(docker ps -aq)" ]; then
              docker stop $(docker ps -aq)
            fi
            docker system prune -a --volumes -f

            # ë°°í¬
            docker-compose -f docker-compose.fe.yml pull
            docker-compose -f docker-compose.fe.yml up -d
            docker-compose -f docker-compose.fe.yml ps

      # ë³´ì•ˆ ê·¸ë£¹ ì •ë¦¬
      - name: Remove GitHub Actions IP from FE Security Group
        if: always()
        run: |
          echo "FE ë³´ì•ˆ ê·¸ë£¹ì—ì„œ GitHub Actions IP ì œê±° ì¤‘: ${{ env.FE_RUNNER_IP }}"
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.AWS_FE_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ env.FE_RUNNER_IP }}/32 || true

      # FE ë°°í¬ ì†Œìš”ì‹œê°„ ê³„ì‚°
      - name: Calculate FE duration
        if: always()
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - FE_START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          echo "FE_DURATION=${MINUTES}ë¶„ ${SECONDS}ì´ˆ" >> $GITHUB_ENV

      # FE ë°°í¬ ê²°ê³¼ ì•Œë¦¼ (ìƒì„¸ ì •ë³´ í¬í•¨)
      - name: Notify Slack on FE Completion
        if: always()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ job.status == 'success' && env.SLACK_SUCCESS_COLOR || env.SLACK_FAILURE_COLOR }}",
                  "title": "${{ job.status == 'success' && 'âœ… FE ë°°í¬ ì„±ê³µ' || 'âŒ FE ë°°í¬ ì‹¤íŒ¨' }}",
                  "fields": [
                    {
                      "title": "í™˜ê²½",
                      "value": "${{ inputs.environment }}",
                      "short": true
                    },
                    {
                      "title": "ìƒíƒœ",
                      "value": "${{ job.status }}",
                      "short": true
                    },
                    {
                      "title": "ì†Œìš”ì‹œê°„",
                      "value": "${{ env.FE_DURATION }}",
                      "short": true
                    },
                    {
                      "title": "ì†ŒìŠ¤ í•´ì‹œ",
                      "value": "${{ needs.build.outputs.source_hash }}",
                      "short": true
                    },
                    {
                      "title": "FE ì„œë²„",
                      "value": "${{ secrets.AWS_FE_EC2_SSH_DNS }}",
                      "short": true
                    },
                    ${{ env.SLACK_COMMON_FIELDS }}
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEPLOY_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # BE ë°°í¬ ì‘ì—…
  deploy-be:
    name: Deploy Backend
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ì‹œì‘ ì‹œê°„ ì„¤ì •
      - name: Set start time
        run: |
          echo "BE_START_TIME=$(date +%s)" >> $GITHUB_ENV
          echo "BE_START_TIME_FORMATTED=$(date '+%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„ %Sì´ˆ')" >> $GITHUB_ENV

      # AWS ì¸ì¦
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_ACCESS_SECRET_KEY }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ë™ì  ë³´ì•ˆ ê·¸ë£¹ ê´€ë¦¬
      - name: Add GitHub Actions IP to BE Security Group
        id: add-ip-be
        run: |
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "BE_RUNNER_IP=$RUNNER_IP" >> $GITHUB_ENV
          echo "BE ë³´ì•ˆ ê·¸ë£¹ì— GitHub Actions IP ì¶”ê°€ ì¤‘: $RUNNER_IP"

          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.AWS_BE_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr $RUNNER_IP/32

      # BE ë°°í¬
      - name: Deploy Backend to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          BE_ENV: ${{ secrets.BACKEND_ENV_FILE }}
          SOURCE_HASH: ${{ needs.build.outputs.source_hash }}
        with:
          host: ${{ secrets.AWS_BE_EC2_SSH_DNS }}
          username: ${{ secrets.AWS_BE_EC2_SSH_USER_NAME }}
          key: ${{ secrets.AWS_BE_EC2_SSH_PEM_KEY }}
          port: ${{ secrets.AWS_BE_EC2_SSH_PORT }}
          envs: ECR_REGISTRY,AWS_REGION,BE_ENV,SOURCE_HASH
          script: |
            set -e

            # ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p ~/workspace/envs
            cd ~/workspace

            # docker-compose.be.yml ìƒì„±
            cat > docker-compose.be.yml << EOF
            version: "3"

            services:
              be:
                container_name: be
                platform: linux/arm64
                image: $ECR_REGISTRY/1-blue/story-dict-be:latest
                restart: always
                env_file:
                  - ./envs/.env.production
                ports:
                  - 9050:9050
            EOF

            # í™˜ê²½ íŒŒì¼ ìƒì„±
            echo "$BE_ENV" > ./envs/.env.production

            # ECR ë¡œê·¸ì¸
            aws ecr get-login-password --region $AWS_REGION | \
              docker login --username AWS --password-stdin $ECR_REGISTRY

            # ì»¨í…Œì´ë„ˆ ì •ë¦¬
            if [ "$(docker ps -aq)" ]; then
              docker stop $(docker ps -aq)
            fi
            docker system prune -a --volumes -f

            # ë°°í¬
            docker-compose -f docker-compose.be.yml pull
            docker-compose -f docker-compose.be.yml up -d
            docker-compose -f docker-compose.be.yml ps

      # ë³´ì•ˆ ê·¸ë£¹ ì •ë¦¬
      - name: Remove GitHub Actions IP from BE Security Group
        if: always()
        run: |
          echo "BE ë³´ì•ˆ ê·¸ë£¹ì—ì„œ GitHub Actions IP ì œê±° ì¤‘: ${{ env.BE_RUNNER_IP }}"
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.AWS_BE_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ env.BE_RUNNER_IP }}/32 || true

      # BE ë°°í¬ ì†Œìš”ì‹œê°„ ê³„ì‚°
      - name: Calculate BE duration
        if: always()
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - BE_START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          echo "BE_DURATION=${MINUTES}ë¶„ ${SECONDS}ì´ˆ" >> $GITHUB_ENV

      # BE ë°°í¬ ê²°ê³¼ ì•Œë¦¼ (ìƒì„¸ ì •ë³´ í¬í•¨)
      - name: Notify Slack on BE Completion
        if: always()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ job.status == 'success' && env.SLACK_SUCCESS_COLOR || env.SLACK_FAILURE_COLOR }}",
                  "title": "${{ job.status == 'success' && 'âœ… BE ë°°í¬ ì„±ê³µ' || 'âŒ BE ë°°í¬ ì‹¤íŒ¨' }}",
                  "fields": [
                    {
                      "title": "í™˜ê²½",
                      "value": "${{ inputs.environment }}",
                      "short": true
                    },
                    {
                      "title": "ìƒíƒœ",
                      "value": "${{ job.status }}",
                      "short": true
                    },
                    {
                      "title": "ì†Œìš”ì‹œê°„",
                      "value": "${{ env.BE_DURATION }}",
                      "short": true
                    },
                    {
                      "title": "ì†ŒìŠ¤ í•´ì‹œ",
                      "value": "${{ needs.build.outputs.source_hash }}",
                      "short": true
                    },
                    {
                      "title": "BE ì„œë²„",
                      "value": "${{ secrets.AWS_BE_EC2_SSH_DNS }}",
                      "short": true
                    },
                    ${{ env.SLACK_COMMON_FIELDS }}
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEPLOY_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # ì „ì²´ ë°°í¬ ê²°ê³¼ ì•Œë¦¼
  notify-completion:
    name: Notify Overall Completion
    needs: [build, deploy-fe, deploy-be]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Notify Slack on Overall Completion
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ needs.deploy-fe.result == 'success' && needs.deploy-be.result == 'success' && env.SLACK_SUCCESS_COLOR || env.SLACK_FAILURE_COLOR }}",
                  "title": "${{ needs.deploy-fe.result == 'success' && needs.deploy-be.result == 'success' && 'âœ… ì „ì²´ ë°°í¬ ì„±ê³µ' || 'âŒ ì „ì²´ ë°°í¬ ì‹¤íŒ¨' }}",
                  "fields": [
                    {
                      "title": "í™˜ê²½",
                      "value": "${{ inputs.environment }}",
                      "short": true
                    },
                    {
                      "title": "FE ìƒíƒœ",
                      "value": "${{ needs.deploy-fe.result }}",
                      "short": true
                    },
                    {
                      "title": "BE ìƒíƒœ",
                      "value": "${{ needs.deploy-be.result }}",
                      "short": true
                    },
                    {
                      "title": "ì†ŒìŠ¤ í•´ì‹œ",
                      "value": "${{ needs.build.outputs.source_hash }}",
                      "short": true
                    },
                    {
                      "title": "S3 ìºì‹œ",
                      "value": "${{ needs.build.outputs.skip_all_build == 'true' && 'âœ… ì „ì²´ íˆíŠ¸' || 'âŒ ë¯¸ìŠ¤' }}",
                      "short": true
                    },
                    {
                      "title": "FE ì´ë¯¸ì§€",
                      "value": "${{ needs.build.outputs.skip_fe_build == 'true' && 'âœ… ìŠ¤í‚µ' || 'ğŸ”¨ ë¹Œë“œ' }}",
                      "short": true
                    },
                    {
                      "title": "BE ì´ë¯¸ì§€",
                      "value": "${{ needs.build.outputs.skip_be_build == 'true' && 'âœ… ìŠ¤í‚µ' || 'ğŸ”¨ ë¹Œë“œ' }}",
                      "short": true
                    },
                    {
                      "title": "ë°°í¬ëœ ì›¹ì‚¬ì´íŠ¸ ì£¼ì†Œ",
                      "value": "<https://story-dict.com|story-dict.com>",
                      "short": true
                    },
                    ${{ env.SLACK_COMMON_FIELDS }}
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEPLOY_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
          SLACK_SUCCESS_COLOR: "#00a63e"
          SLACK_FAILURE_COLOR: "#e7000b"

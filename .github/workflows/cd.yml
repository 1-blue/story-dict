name: CD

on:
  workflow_call:
    inputs:
      environment:
        description: "ë°°í¬ í™˜ê²½"
        required: true
        type: string
      triggered_by:
        description: "íŠ¸ë¦¬ê±° ì†ŒìŠ¤"
        required: false
        type: string
        default: 'manual'
  workflow_dispatch:
    inputs:
      environment:
        description: "ë°°í¬í•  í™˜ê²½ì„ ì„ íƒí•˜ì„¸ìš”"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

permissions:
  contents: read

env:
  # Slack ì•Œë¦¼ ìƒ‰ìƒ ì •ì˜
  SLACK_START_COLOR: "#155dfc"
  SLACK_SUCCESS_COLOR: "#00a63e"
  SLACK_FAILURE_COLOR: "#e7000b"

  # Docker ê´€ë ¨ ì„¤ì •
  DOCKER_PLATFORM: "linux/arm64"
  DOCKER_COMPOSE_VERSION: "v2.24.5"

  # í”„ë¡œì íŠ¸ ê´€ë ¨ ì„¤ì •
  PROJECT_NAME: "story-dict"
  ECR_FE_REPO: "1-blue/story-dict-fe"
  ECR_BE_REPO: "1-blue/story-dict-be"

  # ì‹œê°„ëŒ€ ì„¤ì •
  TZ: "Asia/Seoul"

  # Slack ê³µí†µ í•„ë“œ - ëª¨ë“  ì•Œë¦¼ì—ì„œ ì¬ì‚¬ìš©
  SLACK_COMMON_FIELDS: |
    {
      "title": "ë°°í¬ í™˜ê²½",
      "value": "${{ inputs.environment }}",
      "short": true
    },
    {
      "title": "íŠ¸ë¦¬ê±°",
      "value": "${{ inputs.triggered_by }}",
      "short": true
    },
    {
      "title": "ì›Œí¬í”Œë¡œìš°",
      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/workflows/cd.yml|${{ github.workflow }} ì›Œí¬í”Œë¡œìš°>",
      "short": true
    },
    {
      "title": "ì•¡ì…˜ì‘ì—…",
      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }} ì‘ì—…>",
      "short": true
    },
    {
      "title": "ë ˆí¬ì§€í† ë¦¬",
      "value": "<${{ github.server_url }}/${{ github.repository }}|${{ github.repository }}>",
      "short": true
    },
    {
      "title": "ë¸Œëœì¹˜",
      "value": "${{ github.ref_name }}",
      "short": true
    },
    {
      "title": "ì‹¤í–‰ì",
      "value": "${{ github.actor }}",
      "short": true
    }

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # ì‹œì‘ ì‹œê°„ ì¶”ì ì„ í†µí•œ ë°°í¬ ì†Œìš”ì‹œê°„ ê³„ì‚°
      - name: Set start time
        run: |
          echo "START_TIME=$(date +%s)" >> $GITHUB_ENV
          echo "START_TIME_FORMATTED=$(date '+%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„ %Sì´ˆ')" >> $GITHUB_ENV

      # Node.js ë° pnpm ì„¤ì • (í„°ë³´ ìºì‹œ í™œìš©ì„ ìœ„í•´)
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.12.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'pnpm'

      # í„°ë³´ë ˆí¬ ë¡œì»¬ ìºì‹œ ë³µì›
      - name: Setup Turbo Cache
        uses: actions/cache@v3
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      # ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # AWS CLI ì„¤ì¹˜
      - name: Install AWS CLI
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install
          aws --version

      # S3ì—ì„œ ë¹Œë“œ ìºì‹œ ë³µì› ì‹œë„
      - name: Restore build cache from S3
        run: |
          echo "Checking for build cache in S3..."
          if aws s3 cp s3://${{ secrets.BUILD_CACHE_S3_BUCKET }}/builds/build-cache-${{ github.sha }}.tar.gz ./build-cache.tar.gz; then
            echo "âœ… Build cache found! Restoring..."
            tar -xzf build-cache.tar.gz
            echo "BUILD_CACHE_HIT=true" >> $GITHUB_ENV
            echo "Cache restored successfully"

            # ë³µì›ëœ íŒŒì¼ í™•ì¸
            echo "Restored files:"
            find . -name ".next" -o -name "dist" -o -name "generated" 2>/dev/null || true
          else
            echo "âŒ No build cache found for commit ${{ github.sha }}"
            echo "BUILD_CACHE_HIT=false" >> $GITHUB_ENV
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

      # ìºì‹œ ë¯¸ìŠ¤ì‹œì—ë§Œ ë¹Œë“œ ì‹¤í–‰
      - name: Build applications (cache miss)
        if: env.BUILD_CACHE_HIT == 'false'
        run: |
          echo "ğŸ”¨ Building applications..."
          pnpm build

          # ë¹Œë“œ ë””ë ‰í† ë¦¬ í™•ì¸
          echo "ğŸ“ Verifying build directories..."
          ls -la apps/fe/ || echo "FE directory not found"
          ls -la apps/be/ || echo "BE directory not found"
          ls -la packages/db/prisma/ || echo "Prisma directory not found"

          # ë¹Œë“œ ì™„ë£Œ í›„ S3ì— ìºì‹œ ì €ì¥
          echo "ğŸ’¾ Saving build cache to S3..."
          tar -czf build-cache-${{ github.sha }}.tar.gz \
            --ignore-failed-read \
            apps/fe/.next \
            apps/fe/public \
            apps/be/dist \
            packages/db/prisma/generated

          aws s3 cp build-cache-${{ github.sha }}.tar.gz \
            s3://${{ secrets.BUILD_CACHE_S3_BUCKET }}/builds/

          echo "Build cache saved to S3"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

      # ìºì‹œ íˆíŠ¸ì‹œ ì„±ê³µ ë©”ì‹œì§€
      - name: Build cache hit
        if: env.BUILD_CACHE_HIT == 'true'
        run: echo "âš¡ Using cached build artifacts - no build needed!"

      # Prisma í´ë¼ì´ì–¸íŠ¸ ìƒì„± (ìºì‹œ íˆíŠ¸ì‹œì—ë„ í•„ìš”)
      - name: Generate Prisma client (always needed)
        run: pnpm db:generate

      # ë§ˆì§€ë§‰ ì»¤ë°‹ ë©”ì‹œì§€ ì¶”ì¶œ
      - name: Extract last commit message
        run: |
          SUBJECT=$(git log -1 --pretty=%s)
          echo "COMMIT_SUBJECT=$SUBJECT" >> $GITHUB_ENV

      # Slack ì›¹í›…ì„ í†µí•œ ì‹¤ì‹œê°„ ë°°í¬ ì•Œë¦¼
      - name: Notify Slack on Start
        id: slack-start
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ env.SLACK_START_COLOR }}",
                  "title": "ğŸš€ ë°°í¬ ì‹œì‘",
                  "text": "ë°°í¬ í™˜ê²½: ${{ inputs.environment }}\nì»¤ë°‹: ${{ env.COMMIT_SUBJECT }}",
                  "fields": [
                    {
                      "title": "ì‹œì‘ì‹œê°„",
                      "value": "${{ env.START_TIME_FORMATTED }}",
                      "short": true
                    },
                    {
                      "title": "ì´ë¯¸ì§€ íƒœê·¸ (SHA)",
                      "value": "${{ github.sha }}",
                      "short": true
                    },
                    ${{ env.SLACK_COMMON_FIELDS }}
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEPLOY_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      # í™˜ê²½ íŒŒì¼ ì„¤ì •
      - name: Create Frontend env files
        run: |
          mkdir -p ./envs/fe ./apps/fe
          echo "${{ secrets.FRENTEND_ENV_FILE }}" > ./envs/fe/.env.production
          echo "${{ secrets.FRENTEND_ENV_FILE }}" > ./apps/fe/.env.production

      - name: Create Backend env files
        run: |
          mkdir -p ./envs/be ./apps/be
          echo "${{ secrets.BACKEND_ENV_FILE }}" > ./envs/be/.env.production
          echo "${{ secrets.BACKEND_ENV_FILE }}" > ./apps/be/.env.production

      # Docker Compose ìµœì‹  ë²„ì „ ì„¤ì¹˜
      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/${{ env.DOCKER_COMPOSE_VERSION }}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      # AWS ì¸ì¦ ë° ECR ë¡œê·¸ì¸
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ë©€í‹°ì•„í‚¤í…ì²˜ ë¹Œë“œë¥¼ ìœ„í•œ Docker Buildx ì„¤ì •
      - name: Setup buildx
        run: |
          docker buildx create --use
          docker buildx inspect --bootstrap

      # ë¹Œë“œ ê²°ê³¼ë¬¼ ì¤€ë¹„ ëŒ€ê¸°
      - name: Wait for build completion
        run: |
          echo "Waiting for build artifacts to be ready..."
          sleep 2

          # í•„ìš”í•œ ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸
          if [ ! -d "apps/fe/.next" ] && [ ! -d "apps/be/dist" ]; then
            echo "âŒ Build artifacts not found!"
            exit 1
          fi
          echo "âœ… Build artifacts ready"

      # ì „ì²´ ì´ë¯¸ì§€ ë¹Œë“œ (íŒŒì¼ ë³€ê²½ ê°ì§€ ì œê±°)
      - name: Build and tag images
        run: |
          export ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}

          # ARM64 í”Œë«í¼ìš© ë¹Œë“œ
          DOCKER_DEFAULT_PLATFORM=${{ env.DOCKER_PLATFORM }} docker-compose build

          # FE ì´ë¯¸ì§€ íƒœê·¸ ì„¤ì •
          docker tag ${{ env.ECR_FE_REPO }}:latest $ECR_REGISTRY/${{ env.ECR_FE_REPO }}:latest
          docker tag ${{ env.ECR_FE_REPO }}:latest $ECR_REGISTRY/${{ env.ECR_FE_REPO }}:${{ github.sha }}

          # BE ì´ë¯¸ì§€ íƒœê·¸ ì„¤ì •
          docker tag ${{ env.ECR_BE_REPO }}:latest $ECR_REGISTRY/${{ env.ECR_BE_REPO }}:latest
          docker tag ${{ env.ECR_BE_REPO }}:latest $ECR_REGISTRY/${{ env.ECR_BE_REPO }}:${{ github.sha }}

      # ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ
      - name: Push images to ECR
        run: |
          export ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}

          # FE ì´ë¯¸ì§€ í‘¸ì‹œ
          docker push $ECR_REGISTRY/${{ env.ECR_FE_REPO }}:latest
          docker push $ECR_REGISTRY/${{ env.ECR_FE_REPO }}:${{ github.sha }}

          # BE ì´ë¯¸ì§€ í‘¸ì‹œ
          docker push $ECR_REGISTRY/${{ env.ECR_BE_REPO }}:latest
          docker push $ECR_REGISTRY/${{ env.ECR_BE_REPO }}:${{ github.sha }}

      # ë™ì  ë³´ì•ˆ ê·¸ë£¹ ê´€ë¦¬ë¡œ SSH ì ‘ê·¼ ì œí•œ
      - name: Add GitHub Actions IP to Security Group
        id: add-ip
        run: |
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "RUNNER_IP=$RUNNER_IP" >> $GITHUB_ENV
          echo "Adding GitHub Actions IP to Security Group: $RUNNER_IP"

          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.AWS_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr $RUNNER_IP/32

      # SSHë¥¼ í†µí•œ EC2 ë°°í¬ ë° ECR ì´ë¯¸ì§€ ìë™ ë°°í¬
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_EC2_SSH_DNS }}
          username: ${{ secrets.AWS_EC2_SSH_USER_NAME }}
          key: ${{ secrets.AWS_EC2_SSH_PEM_KEY }}
          port: ${{ secrets.AWS_EC2_SSH_PORT }}
          script: |
            cd workspace

            # ECR ì¸ì¦ ë° ë¡œê·¸ì¸
            export ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | sudo docker login --username AWS --password-stdin $ECR_REGISTRY

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            sudo docker stop $(sudo docker ps -aq) || true
            sudo docker system prune -a --volumes -f

            # ìµœì‹  ì´ë¯¸ì§€ë¡œ ì„œë¹„ìŠ¤ ì‹œì‘
            sudo docker-compose pull
            sudo docker-compose up -d

            # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            sudo docker-compose ps

      # ë³´ì•ˆ ê·¸ë£¹ ì •ë¦¬ (ì‹¤íŒ¨ ì‹œì—ë„ ì‹¤í–‰)
      - name: Remove GitHub Actions IP from Security Group
        if: always()
        run: |
          echo "Removing GitHub Actions IP from Security Group: ${{ env.RUNNER_IP }}"
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.AWS_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ env.RUNNER_IP }}/32 || true

      # ë°°í¬ ì†Œìš”ì‹œê°„ ê³„ì‚°
      - name: Calculate duration
        if: always()
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          echo "DURATION=${MINUTES}ë¶„ ${SECONDS}ì´ˆ" >> $GITHUB_ENV
          echo "Total deployment time: ${MINUTES}ë¶„ ${SECONDS}ì´ˆ"

      # ë°°í¬ ê²°ê³¼ ì•Œë¦¼
      - name: Notify Slack on Success
        if: success()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ env.SLACK_SUCCESS_COLOR }}",
                  "title": "âœ… ë°°í¬ ì„±ê³µ",
                  "text": "ë°°í¬ í™˜ê²½: ${{ inputs.environment }}\nì»¤ë°‹: ${{ env.COMMIT_SUBJECT }}",
                  "fields": [
                    {
                      "title": "ì†Œìš”ì‹œê°„",
                      "value": "${{ env.DURATION }}",
                      "short": true
                    },
                    {
                      "title": "ì´ë¯¸ì§€ íƒœê·¸ (SHA)",
                      "value": "${{ github.sha }}",
                      "short": true
                    },
                    ${{ env.SLACK_COMMON_FIELDS }}
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEPLOY_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Notify Slack on Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ env.SLACK_FAILURE_COLOR }}",
                  "title": "âŒ ë°°í¬ ì‹¤íŒ¨",
                  "text": "ë°°í¬ í™˜ê²½: ${{ inputs.environment }}\nì»¤ë°‹: ${{ env.COMMIT_SUBJECT }}",
                  "fields": [
                    {
                      "title": "ì†Œìš”ì‹œê°„",
                      "value": "${{ env.DURATION }}",
                      "short": true
                    },
                    {
                      "title": "ì´ë¯¸ì§€ íƒœê·¸ (SHA)",
                      "value": "${{ github.sha }}",
                      "short": true
                    },
                    ${{ env.SLACK_COMMON_FIELDS }}
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEPLOY_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
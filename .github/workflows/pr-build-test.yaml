name: PR Build Test

on:
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read

env:
  SLACK_START_COLOR: "#6366f1"
  SLACK_SUCCESS_COLOR: "#22c55e"
  SLACK_FAILURE_COLOR: "#ef4444"
  SLACK_COMMON_FIELDS: |
    {
      "title": "PR ì œëª©",
      "value": "${{ github.event.pull_request.title }}",
      "short": true
    },
    {
      "title": "ì›Œí¬í”Œë¡œìš°",
      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/workflows/pr-build-test.yaml|${{ github.workflow }} ì›Œí¬í”Œë¡œìš°>",
      "short": true
    },
    {
      "title": "ì•¡ì…˜ì‘ì—…",
      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }} ì‘ì—…>",
      "short": true
    },
    {
      "title": "PR ë¸Œëœì¹˜",
      "value": "${{ format('{0} â†’ {1}', github.event.pull_request.head.ref, github.event.pull_request.base.ref) }}",
      "short": true
    }

jobs:
  build-test:
    name: Build and Test
    runs-on: ubuntu-latest
    if: always()
    steps:
    - uses: actions/checkout@v3

    # ì‹œì‘ ì‹œê°„ ì„¤ì •
    - name: Set start time
      run: |
        echo "TZ='Asia/Seoul'" >> $GITHUB_ENV
        echo "START_TIME=$(TZ='Asia/Seoul' date +%s)" >> $GITHUB_ENV
        echo "START_TIME_FORMATTED=$(TZ='Asia/Seoul' date '+%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„ %Sì´ˆ')" >> $GITHUB_ENV

    # ë¹Œë“œ ì‹œì‘ ì•Œë¦¼
    - name: Notify Slack on Start
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "attachments": [
              {
                "color": "${{ env.SLACK_START_COLOR }}",
                "title": "ğŸ”¨ PR ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹œì‘ ğŸ”¨",
                "text": "${{ format('{0} â†’ {1}', github.event.pull_request.head.ref, github.event.pull_request.base.ref) }}",
                "fields": [
                  {
                    "title": "ì‹œì‘ì‹œê°„",
                    "value": "${{ env.START_TIME_FORMATTED }}",
                    "short": true
                  },
                  ${{ env.SLACK_COMMON_FIELDS }}
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_PR_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

    - name: Create Frontend env files
      run: |
        mkdir -p ./envs/fe
        mkdir -p ./apps/fe
        echo "${{ secrets.FRENTEND_ENV_FILE }}" > ./envs/fe/.env.production
        echo "${{ secrets.FRENTEND_ENV_FILE }}" > ./apps/fe/.env.production

    - name: Create Backend env files
      run: |
        mkdir -p ./envs/be
        mkdir -p ./apps/be
        echo "${{ secrets.BACKEND_ENV_FILE }}" > ./envs/be/.env.production
        echo "${{ secrets.BACKEND_ENV_FILE }}" > ./apps/be/.env.production

    - name: Install Docker Compose
      run: |
        sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose

    - name: Docker LogIn
      run: |
        docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

    - name: Docker Build Test
      run: |
        docker buildx create --use
        DOCKER_DEFAULT_PLATFORM=linux/arm64 docker-compose build

    # ì•¡ì…˜ ì´ ì†Œìš”ì‹œê°„ ê³„ì‚°
    - name: Calculate duration
      if: always()
      run: |
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        MINUTES=$((DURATION / 60))
        SECONDS=$((DURATION % 60))
        echo "DURATION=${MINUTES}ë¶„ ${SECONDS}ì´ˆ" >> $GITHUB_ENV

    # ë¹Œë“œ ì„±ê³µ ì•Œë¦¼
    - name: Notify Slack on Success
      if: success()
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "attachments": [
              {
                "color": "${{ env.SLACK_SUCCESS_COLOR }}",
                "title": "â­•ï¸ PR ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ â­•ï¸",
                "text": "${{ format('{0} â†’ {1}', github.event.pull_request.head.ref, github.event.pull_request.base.ref) }}",
                "fields": [
                  {
                    "title": "ì†Œìš”ì‹œê°„",
                    "value": "${{ env.DURATION }}",
                    "short": true
                  },
                  ${{ env.SLACK_COMMON_FIELDS }}
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_PR_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

    # ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼
    - name: Notify Slack on Failure
      if: failure()
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "attachments": [
              {
                "color": "${{ env.SLACK_FAILURE_COLOR }}",
                "title": "âŒ PR ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ âŒ",
                "text": "${{ format('{0} â†’ {1}', github.event.pull_request.head.ref, github.event.pull_request.base.ref) }}",
                "fields": [
                  {
                    "title": "ì†Œìš”ì‹œê°„",
                    "value": "${{ env.DURATION }}",
                    "short": true
                  },
                  ${{ env.SLACK_COMMON_FIELDS }}
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_PR_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK 
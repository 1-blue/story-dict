name: CI

run-name: >-
  ${{ github.event_name == 'workflow_dispatch' && format('CI (ìˆ˜ë™): {0}', github.event.head_commit.message || github.ref_name) ||
      github.event_name == 'pull_request' && format('CI (PR): {0}', github.event.pull_request.title) ||
      'CI' }}

on:
  pull_request:
    branches: [master, development]
  workflow_dispatch:
    inputs:
      run_deployment:
        description: "ë°°í¬(CD)ë„ í•¨ê»˜ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
        required: false
        default: true
        type: boolean

env:
  # Slack ì•Œë¦¼ ìƒ‰ìƒ ì •ì˜
  SLACK_START_COLOR: "#155dfc"
  SLACK_SUCCESS_COLOR: "#00a63e"
  SLACK_FAILURE_COLOR: "#e7000b"

  # ì‹œê°„ëŒ€ ì„¤ì •
  TZ: "Asia/Seoul"

jobs:
  ci:
    name: Code Quality & Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      should_deploy: ${{ steps.check-deploy.outputs.should_deploy }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # ì‹œì‘ ì‹œê°„ ë° CI ì •ë³´ ì„¤ì • (í†µí•©)
      - name: Set CI info and start time
        run: |
          echo "START_TIME=$(date +%s)" >> $GITHUB_ENV
          echo "START_TIME_FORMATTED=$(date '+%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„ %Sì´ˆ')" >> $GITHUB_ENV
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "CI_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
            echo "CI_TYPE=PR" >> $GITHUB_ENV
          else
            SUBJECT=$(git log -1 --pretty=%s)
            echo "CI_TITLE=$SUBJECT" >> $GITHUB_ENV
            echo "CI_TYPE=ìˆ˜ë™" >> $GITHUB_ENV
          fi

      # ì†ŒìŠ¤ì½”ë“œ í•´ì‹œ ê³„ì‚° (ì¡°ê¸° ì‹¤í–‰ìœ¼ë¡œ ìºì‹œ í™•ì¸ ê°€ëŠ¥)
      - name: Calculate source hash
        id: source-hash
        run: |
          SOURCE_HASH=$(find apps packages -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.json" -o -name "*.prisma" | grep -v "/dist/" | grep -v "/.next/" | sort | xargs cat | sha256sum | cut -d' ' -f1)
          echo "SOURCE_HASH=$SOURCE_HASH" >> $GITHUB_OUTPUT
          echo "âœ… ì†ŒìŠ¤ì½”ë“œ í•´ì‹œ: $SOURCE_HASH"

      # S3 ë¹Œë“œ ìºì‹œ ì¡°ê¸° í™•ì¸ (ì˜ì¡´ì„± ì„¤ì¹˜ ì „)
      - name: Early build cache check
        if: github.ref == 'refs/heads/master' && github.event_name != 'pull_request'
        id: early-cache-check
        run: |
          SOURCE_HASH=${{ steps.source-hash.outputs.SOURCE_HASH }}
          if aws s3 ls s3://${{ secrets.AWS_S3_BUCKET }}/builds/${SOURCE_HASH}.tar.gz; then
            echo "ğŸ‰ ë¹Œë“œ ìºì‹œ ì¡´ì¬ - CI ì‘ì—…ë§Œ ì‹¤í–‰ (í•´ì‹œ: $SOURCE_HASH)"
            echo "CACHE_EXISTS=true" >> $GITHUB_OUTPUT
            echo "SKIP_BUILD=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ë¹Œë“œ ìºì‹œ ì—†ìŒ - ì „ì²´ ë¹Œë“œ ì‹¤í–‰ (í•´ì‹œ: $SOURCE_HASH)"
            echo "CACHE_EXISTS=false" >> $GITHUB_OUTPUT
            echo "SKIP_BUILD=false" >> $GITHUB_OUTPUT
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_ACCESS_SECRET_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.12.0

      - name: Setup Node.js with optimized caching
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      # Turbo ì›ê²© ìºì‹œ ì„¤ì • (ë¡œì»¬ê³¼ ì›ê²© ëª¨ë‘)
      - name: Setup Turbo Cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: pnpm db:generate

      - name: Create frontend .env file
        if: github.ref == 'refs/heads/master' && github.event_name != 'pull_request'
        run: |
          echo "${{ secrets.FRONTEND_ENV_FILE }}" > apps/fe/.env.production
          echo "${{ secrets.BACKEND_ENV_FILE }}" > apps/be/.env.production
          echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ, ë°±ì—”ë“œ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì™„ë£Œ"

      - name: Run CI (lint, type-check only)
        run: pnpm ci:affected

      # CI ì‹œì‘ ì•Œë¦¼ (ê°„ì†Œí™”)
      - name: Notify Slack on Start
        if: github.event_name != 'pull_request'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ env.SLACK_START_COLOR }}",
                  "title": "ğŸ” CI ì‹œì‘",
                  "text": "${{ env.CI_TITLE }}",
                  "fields": [
                    {
                      "title": "íƒ€ì…",
                      "value": "${{ env.CI_TYPE }}",
                      "short": true
                    },
                    {
                      "title": "ì‹¤í–‰ì",
                      "value": "${{ github.actor }}",
                      "short": true
                    },
                    {
                      "title": "ë¸Œëœì¹˜",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    },
                    {
                      "title": "ì•¡ì…˜ì‘ì—…",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }} ì‘ì—…>",
                      "short": true
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_PR_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      # ë¹Œë“œ ë° S3 ìºì‹œ ì €ì¥ (ìºì‹œ ì—†ì„ ë•Œë§Œ)
      - name: Build and cache to S3
        if: github.ref == 'refs/heads/master' && github.event_name != 'pull_request' && steps.early-cache-check.outputs.SKIP_BUILD == 'false'
        run: |
          echo "ğŸ”¨ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì¤‘..."
          pnpm build

          SOURCE_HASH=${{ steps.source-hash.outputs.SOURCE_HASH }}
          echo "ğŸ’¾ S3ì— ë¹Œë“œ ìºì‹œ ì €ì¥ ì¤‘..."
          tar -czf ${SOURCE_HASH}.tar.gz \
            --ignore-failed-read \
            apps/fe/.next \
            apps/fe/public \
            apps/be/dist \
            packages/

          aws s3 cp ${SOURCE_HASH}.tar.gz \
            s3://${{ secrets.AWS_S3_BUCKET }}/builds/

          # ì»¤ë°‹ SHAì™€ ì†ŒìŠ¤ í•´ì‹œ ë§¤í•‘ ì €ì¥ (CDì—ì„œ ì°¸ì¡°ìš©)
          echo "${SOURCE_HASH}" > source-hash-${{ github.sha }}.txt
          aws s3 cp source-hash-${{ github.sha }}.txt \
            s3://${{ secrets.AWS_S3_BUCKET }}/mappings/

          echo "âœ… ë¹Œë“œ ìºì‹œ ì €ì¥ ì™„ë£Œ (í•´ì‹œ: $SOURCE_HASH)"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_ACCESS_SECRET_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

      # CI ì†Œìš”ì‹œê°„ ê³„ì‚°
      - name: Calculate CI duration
        if: always()
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          echo "DURATION=${MINUTES}ë¶„ ${SECONDS}ì´ˆ" >> $GITHUB_ENV

      # CI ì™„ë£Œ ì•Œë¦¼ (ìƒì„¸ ì •ë³´ í¬í•¨)
      - name: Notify Slack on Completion
        if: always() && github.event_name != 'pull_request'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ job.status == 'success' && env.SLACK_SUCCESS_COLOR || env.SLACK_FAILURE_COLOR }}",
                  "title": "${{ job.status == 'success' && 'âœ… CI ì„±ê³µ' || 'âŒ CI ì‹¤íŒ¨' }}",
                  "text": "${{ env.CI_TITLE }}",
                  "fields": [
                    {
                      "title": "íƒ€ì…",
                      "value": "${{ env.CI_TYPE }}",
                      "short": true
                    },
                    {
                      "title": "ìƒíƒœ",
                      "value": "${{ job.status }}",
                      "short": true
                    },
                    {
                      "title": "ë¹Œë“œ ìºì‹œ",
                      "value": "${{ steps.early-cache-check.outputs.CACHE_EXISTS == 'true' && 'âœ… íˆíŠ¸' || 'âŒ ë¯¸ìŠ¤' }}",
                      "short": true
                    },
                    {
                      "title": "ë¹Œë“œ ì‹¤í–‰",
                      "value": "${{ steps.early-cache-check.outputs.SKIP_BUILD == 'true' && 'â­ï¸ ìŠ¤í‚µ' || 'ğŸ”¨ ì‹¤í–‰' }}",
                      "short": true
                    },
                    {
                      "title": "CD ì‹¤í–‰",
                      "value": "${{ steps.check-deploy.outputs.should_deploy == 'true' && 'ğŸš€ ì˜ˆ' || 'â¹ï¸ ì•„ë‹ˆìš”' }}",
                      "short": true
                    },
                    {
                      "title": "ì†Œìš”ì‹œê°„",
                      "value": "${{ env.DURATION }}",
                      "short": true
                    },
                    {
                      "title": "ì†ŒìŠ¤ í•´ì‹œ",
                      "value": "${{ steps.source-hash.outputs.SOURCE_HASH }}",
                      "short": true
                    },
                    {
                      "title": "ì‹œì‘ì‹œê°„",
                      "value": "${{ env.START_TIME_FORMATTED }}",
                      "short": true
                    },
                    {
                      "title": "ì›Œí¬í”Œë¡œìš° ëª©ë¡",
                      "value": "<https://github.com/1-blue/story-dict/actions/workflows/ci.yml|CI ì›Œí¬í”Œë¡œìš° ëª©ë¡>",
                      "short": true
                    },
                    {
                      "title": "ì•¡ì…˜ì‘ì—…",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }} ì‘ì—…>",
                      "short": true
                    },
                    {
                      "title": "ë¸Œëœì¹˜",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    },
                    {
                      "title": "ì‹¤í–‰ì",
                      "value": "${{ github.actor }}",
                      "short": true
                    },
                    {
                      "title": "S3 ë¹Œë“œ ìºì‹œ",
                      "value": "<https://ap-northeast-2.console.aws.amazon.com/s3/buckets/storydict?region=ap-northeast-2&bucketType=general&prefix=builds/&showversions=false|S3 ë²„í‚·>",
                      "short": true
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_PR_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Check if deployment needed
        id: check-deploy
        run: |
          # ìˆ˜ë™ ì‹¤í–‰ ì‹œ ì²´í¬ë°•ìŠ¤ ê°’ í™•ì¸
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.run_deployment }}" == "true" ]]; then
              echo "should_deploy=true" >> $GITHUB_OUTPUT
              echo "ğŸš€ ìˆ˜ë™ ì‹¤í–‰: ë°°í¬ë„ í•¨ê»˜ ì‹¤í–‰í•©ë‹ˆë‹¤"
            else
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              echo "â¹ï¸ ìˆ˜ë™ ì‹¤í–‰: ë°°í¬ëŠ” ê±´ë„ˆëœë‹ˆë‹¤"
            fi
          # PRì¸ ê²½ìš° ë°°í¬ ì œì™¸
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "â¹ï¸ PR ì‹¤í–‰: ë°°í¬ëŠ” ì œì™¸í•˜ê³  CIë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤"
          fi

  trigger-cd:
    name: Trigger Deployment
    needs: ci
    if: needs.ci.outputs.should_deploy == 'true' && success()
    uses: ./.github/workflows/cd.yml
    with:
      environment: "production"
      triggered_by: "ci"
    secrets: inherit

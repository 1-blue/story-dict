name: CD with Docker

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read

jobs:
  Deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    # Î∞∞Ìè¨ ÏãúÏûë ÏïåÎ¶º
    - name: Notify Slack on Start
      id: slack-start
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "attachments": [
              {
                "color": "#9B59B6",
                "title": "üöÄ Î∞∞Ìè¨ ÏãúÏûë üöÄ",
                "title_link": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "text": "Commit: \"${{ github.event.head_commit.message }}\"",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "<${{ github.server_url }}/${{ github.repository }}|${{ github.repository }}>",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}|${{ github.ref_name }}>",
                    "short": true
                  },
                  {
                    "title": "Action",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/workflows/cicd.yaml|CI/CD Pipeline>",
                    "short": true
                  },
                  {
                    "title": "Job",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Deploy>",
                    "short": true
                  },
                  {
                    "title": "Time",
                    "value": "${{ github.event.head_commit.timestamp }}",
                    "short": true
                  },
                  {
                    "title": "Commit Message",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.event.head_commit.message }}>",
                    "short": true
                  }
                ]      
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

    - name: Create Frontend env files
      run: |
        mkdir -p ./envs/fe
        mkdir -p ./apps/fe
        echo "${{ secrets.FRENTEND_ENV_FILE }}" > ./envs/fe/.env.production
        echo "${{ secrets.FRENTEND_ENV_FILE }}" > ./apps/fe/.env.production

    - name: Create Backend env files
      run: |
        mkdir -p ./envs/be
        mkdir -p ./apps/be
        echo "${{ secrets.BACKEND_ENV_FILE }}" > ./envs/be/.env.production
        echo "${{ secrets.BACKEND_ENV_FILE }}" > ./apps/be/.env.production

    - name: Install Docker Compose
      run: |
        sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose

    - name: Docker LogIn
      run: |
        docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

    - name: Docker Build
      run: |
        docker buildx create --use
        DOCKER_DEFAULT_PLATFORM=linux/arm64 docker-compose build

    - name: Docker Push
      run: |
        docker-compose push

    # AWS Ïù∏Ï¶ù
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-region: ${{ secrets.AWS_REGION }}
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
        aws-secret-access-key: ${{ secrets.AWS_ACCESS_SECRET_KEY }}

    # Î≥¥Ïïà Í∑∏Î£πÏóê Ïù∏Î∞îÏö¥Îìú Í∑úÏπô Ï∂îÍ∞Ä
    - name: Add GitHub Actions IP to Security Group
      run: |
        # GitHub Actions Îü¨ÎÑàÏùò Í≥µÏù∏ IP Ï£ºÏÜå Í∞ÄÏ†∏Ïò§Í∏∞
        RUNNER_IP=$(curl -s https://api.ipify.org)
        echo "Add GitHub Actions IP to Security Group: $RUNNER_IP"
        aws ec2 authorize-security-group-ingress \
          --group-id ${{ secrets.AWS_SECURITY_GROUP_ID }} \
          --protocol tcp \
          --port 22 \
          --cidr $RUNNER_IP/32

    # EC2 Î∞∞Ìè¨
    - name: Deploy Frontend And Backend
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.AWS_EC2_SSH_DNS }} # EC2 IP Ï£ºÏÜå
        username: ${{ secrets.AWS_EC2_SSH_USER_NAME }} # EC2 ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ
        key: ${{ secrets.AWS_EC2_SSH_PEM_KEY }} # EC2Ïùò .pem ÌÇ§
        port: ${{ secrets.AWS_EC2_SSH_PORT }} # EC2 Ìè¨Ìä∏
        script: |
          cd workspace &&
          sudo docker stop $(sudo docker ps -aq) || true &&
          sudo docker system prune -a --volumes -f &&
          sudo docker-compose up -d

    # Î≥¥Ïïà Í∑∏Î£πÏóêÏÑú Ïù∏Î∞îÏö¥Îìú Í∑úÏπô Ï†úÍ±∞
    - name: Remove GitHub Actions IP from Security Group
      if: always()  # Ïù¥Ï†Ñ Îã®Í≥ÑÍ∞Ä Ïã§Ìå®ÌïòÎçîÎùºÎèÑ Ìï≠ÏÉÅ Ïã§Ìñâ
      run: |
        RUNNER_IP=$(curl -s https://api.ipify.org)
        echo "Remove GitHub Actions IP from Security Group: $RUNNER_IP"
        aws ec2 revoke-security-group-ingress \
          --group-id ${{ secrets.AWS_SECURITY_GROUP_ID }} \
          --protocol tcp \
          --port 22 \
          --cidr $RUNNER_IP/32

    # Î∞∞Ìè¨ ÏÑ±Í≥µ ÏïåÎ¶º
    - name: Notify Slack on Success
      if: success()
      id: slack-success
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "attachments": [
              {
                "color": "#2ECC71",
                "title": "‚≠ïÔ∏è Î∞∞Ìè¨ ÏÑ±Í≥µ ‚≠ïÔ∏è",
                "title_link": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "text": "Commit: \"${{ github.event.head_commit.message }}\"",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "<${{ github.server_url }}/${{ github.repository }}|${{ github.repository }}>",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}|${{ github.ref_name }}>",
                    "short": true
                  },
                  {
                    "title": "Action",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/workflows/cicd.yaml|CI/CD Pipeline>",
                    "short": true
                  },
                  {
                    "title": "Job",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Deploy>",
                    "short": true
                  },
                  {
                    "title": "Time",
                    "value": "${{ github.event.head_commit.timestamp }}",
                    "short": true
                  },
                  {
                    "title": "Commit Message",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.event.head_commit.message }}>",
                    "short": true
                  }
                ]      
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

    # Î∞∞Ìè¨ Ïã§Ìå® ÏïåÎ¶º
    - name: Notify Slack on Failure
      if: failure()
      id: slack-failure
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "attachments": [
              {
                "color": "#E74C3C",
                "title": "‚ùå Î∞∞Ìè¨ Ïã§Ìå® ‚ùå",
                "title_link": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "text": "Commit: \"${{ github.event.head_commit.message }}\"",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "<${{ github.server_url }}/${{ github.repository }}|${{ github.repository }}>",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}|${{ github.ref_name }}>",
                    "short": true
                  },
                  {
                    "title": "Action",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/workflows/cicd.yaml|CI/CD Pipeline>",
                    "short": true
                  },
                  {
                    "title": "Job",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Deploy>",
                    "short": true
                  },
                  {
                    "title": "Time",
                    "value": "${{ github.event.head_commit.timestamp }}",
                    "short": true
                  },
                  {
                    "title": "Commit Message",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.event.head_commit.message }}>",
                    "short": true
                  }
                ]      
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
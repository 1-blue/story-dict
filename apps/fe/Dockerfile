FROM node:20-alpine AS base

# ======================================== ì„¤ì¹˜ ì „ìš© ì‹¤í–‰ ìŠ¤í…Œì´ì§€ ========================================
FROM base AS installer

# `node:20-alpine`ë¼ì„œ ëˆ„ë½ëœ ê³µìœ  ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
RUN apk update && apk add --no-cache libc6-compat
RUN ln -s /usr/lib/libssl.so.3 /lib/libssl.so.3

# turbo ì „ì—­ ì„¤ì¹˜
RUN npm install -g turbo

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# fe ì˜ì¡´ì„±ë§Œ ë„ì»¤ ìµœì í™” ëª¨ë“œë¡œ ì„¤ì¹˜
RUN turbo prune fe --docker

# ======================================== ë¹Œë“œ ì „ìš© ì‹¤í–‰ ìŠ¤í…Œì´ì§€ ========================================
FROM base AS builder

# ëˆ„ë½ëœ ê³µìœ  ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
RUN apk update && apk add --no-cache libc6-compat
RUN ln -s /usr/lib/libssl.so.3 /lib/libssl.so.3

# pnpm ì „ì—­ ì„¤ì¹˜
RUN npm install -g pnpm

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € íŒŒì¼ë“¤ ë³µì‚¬ ë° ì„¤ì¹˜
COPY --from=installer /app/out/json/ .
RUN pnpm install

# ì‹¤ì œ ì†ŒìŠ¤ ì½”ë“œì™€ ì„¤ì • íŒŒì¼
COPY --from=installer /app/out/full/ .

# ë¹Œë“œ ì²˜ë¦¬ (ë¹Œë“œ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸)
RUN if [ -d "apps/fe/.next" ] && [ -d "apps/fe/public" ]; then \
      echo "âœ… ë¹Œë“œ íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ìºì‹œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."; \
    else \
      echo "ğŸ”¨ ë¹Œë“œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ë¹Œë“œí•©ë‹ˆë‹¤."; \
      pnpm turbo build; \
    fi

# ======================================== ì‹¤í–‰ ì „ìš© ì‹¤í–‰ ìŠ¤í…Œì´ì§€ ========================================
FROM base AS runner

RUN ln -s /usr/lib/libssl.so.3 /lib/libssl.so.3

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì¶”ê°€
ENV PORT=9000
ENV HOSTNAME="0.0.0.0"
ENV NODE_OPTIONS="--max-old-space-size=4096"

# ì‹¤í–‰ íŒŒì¼ ë³µì‚¬
COPY --from=builder /app/apps/fe/.next/standalone ./
COPY --from=builder /app/apps/fe/.next/static ./apps/fe/.next/static
COPY --from=builder /app/apps/fe/public ./apps/fe/public

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 9000

# ì‹¤í–‰ ëª…ë ¹ì–´
CMD ["node", "apps/fe/server.js"]
# CMD ["tail", "-f", "/dev/null"]
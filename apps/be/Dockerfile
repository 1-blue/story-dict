FROM node:20-alpine AS base

# ======================================== ì„¤ì¹˜ ì „ìš© ì‹¤í–‰ ìŠ¤í…Œì´ì§€ ========================================
FROM base AS installer

# `node:20-alpine`ë¼ì„œ ëˆ„ë½ëœ ê³µìœ  ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
RUN apk update && apk add --no-cache libc6-compat openssl

# turbo ì „ì—­ ì„¤ì¹˜
RUN npm install -g turbo

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# be ì˜ì¡´ì„±ë§Œ ë„ì»¤ ìµœì í™” ëª¨ë“œë¡œ ì„¤ì¹˜
RUN turbo prune be --docker

# ======================================== ë¹Œë“œ ì „ìš© ì‹¤í–‰ ìŠ¤í…Œì´ì§€ ========================================
FROM base AS builder

# ëˆ„ë½ëœ ê³µìœ  ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
RUN apk update && apk add --no-cache libc6-compat openssl

# pnpm ì „ì—­ ì„¤ì¹˜
RUN npm install -g pnpm

# ë£¨íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ í›„ ë¹Œë“œ
WORKDIR /app

# íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € íŒŒì¼ë“¤ ë³µì‚¬ ë° ì„¤ì¹˜
COPY --from=installer /app/out/json/ .
RUN pnpm install

# ì‹¤ì œ ì†ŒìŠ¤ ì½”ë“œì™€ ì„¤ì • íŒŒì¼
COPY --from=installer /app/out/full/ .

# ë¹Œë“œ ì²˜ë¦¬ (ë¹Œë“œ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸)
RUN if [ -d "apps/be/dist" ] && [ -d "packages/database/dist" ]; then \
      echo "âœ… ë¹Œë“œ íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ìºì‹œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."; \
    else \
      echo "ğŸ”¨ ë¹Œë“œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ë¹Œë“œí•©ë‹ˆë‹¤."; \
      pnpm turbo build; \
    fi

# ======================================== ì‹¤í–‰ ì „ìš© ì‹¤í–‰ ìŠ¤í…Œì´ì§€ ========================================
FROM base AS runner

# OpenSSL 1.1 ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
RUN apk update && apk add --no-cache libc6-compat openssl

# pnpm ì „ì—­ ì„¤ì¹˜ ì¶”ê°€
RUN npm install -g pnpm

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì • 
WORKDIR /app

# ë¹Œë“œëœ íŒŒì¼ ë³µì‚¬
COPY --from=builder /app/apps/be/dist ./apps/be/dist
COPY --from=builder /app/apps/be/node_modules ./apps/be/node_modules
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/packages ./packages

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 9050

# ì‹¤í–‰ ëª…ë ¹ì–´
CMD ["node", "./apps/be/dist/main.js"]
# CMD ["tail", "-f", "/dev/null"]